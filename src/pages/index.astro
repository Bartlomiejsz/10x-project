---
import Layout from '@/layouts/Layout.astro';
import DashboardApp from '@/components/dashboard/DashboardApp';
import { normalizeMonthParam } from '@/lib/month';

const { locals, url } = Astro;
const supabase = locals.supabase;

const skipAuth = import.meta.env.SKIP_AUTH || false;

const { data, error } = await supabase.auth.getUser();
const user = data?.user;

if ((error || !user) && !skipAuth) {
    return Astro.redirect('/auth/login');
}

const normalizedMonth = normalizeMonthParam(url.searchParams.get('month') ?? undefined);
---

<Layout>
    <DashboardApp client:load initialMonth={normalizedMonth.value} />
</Layout>
